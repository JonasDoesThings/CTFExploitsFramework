from paramiko.client import SSHClient, AutoAddPolicy

from core.logger.Logger import Logger


class SSHTarget:

    def __init__(self, host, port=22, timeout=10):
        self.host = host
        self.port = int(port)
        self.timeout = timeout

        self.ssh_client = SSHClient()
        self.ssh_client.set_missing_host_key_policy(AutoAddPolicy())

    def connect(self, username, password):
        self.ssh_client.connect(self.host, self.port, username, password, timeout=self.timeout)

    def connect_with_key(self, username, key):
        self.ssh_client.connect(self.host, self.port, username, key_filename=key, timeout=self.timeout)

    def close(self):
        self.ssh_client.close()

    def send(self, data):
        tdin, stdout, stderr = self.ssh_client.exec_command(data)

        if stderr.readline() != "":
            Logger.warning("STDERR was not null! (" + stderr.read().decode("utf-8") + ")")

        return stdout.read().decode("utf-8")
